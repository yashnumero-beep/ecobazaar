<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoBazaar - Carbon-Aware Marketplace</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-green: #2ecc71;
            --dark-green: #27ae60;
            --bg-color: #f0fdf4;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --danger: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); }
        .hidden { display: none !important; }

        /* Auth Page */
        .auth-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .auth-container { background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                         width: 900px; max-width: 90%; display: flex; min-height: 600px; }
        .info-side { flex: 1; background: linear-gradient(to bottom right, var(--dark-green), var(--primary-green));
                     color: white; padding: 40px; display: flex; flex-direction: column; justify-content: center;
                     align-items: center; text-align: center; }
        .form-side { flex: 1.2; padding: 50px; display: flex; flex-direction: column; justify-content: center; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid #e2e8f0;
                                                  border-radius: 8px; background: #f8fafc; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary-green); color: white; }
        .btn-primary:hover { background: var(--dark-green); }
        .btn-outline { border: 2px solid var(--primary-green); color: var(--primary-green); background: transparent; }

        /* App Layout */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .navbar { background: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                 display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--dark-green); }
        .nav-links { display: flex; gap: 20px; }
        .nav-item { cursor: pointer; color: #64748b; font-weight: 600; padding: 8px 12px; border-radius: 6px; }
        .nav-item:hover, .nav-item.active { color: var(--primary-green); background: #f0fdf4; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; max-width: 1200px; margin: 0 auto; width: 100%; }

        /* Products */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .product-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                       display: flex; flex-direction: column; }
        .product-card:hover { transform: translateY(-5px); transition: 0.2s; }
        .product-img { height: 150px; background: #eee; border-radius: 8px; margin-bottom: 15px; object-fit: cover; width: 100%; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .badge-A-plus { background: #00b894; color: white; }
        .badge-B { background: #ffeaa7; color: #2d3436; }
        .badge-C { background: #fab1a0; color: white; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary-green); margin: 10px 0; }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f1f2f6; }
        .data-table th { background: #f8fafc; font-weight: 600; }

        /* Achievement Badge */
        .achievement-badge { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px;
                            text-align: center; transition: 0.3s; }
        .achievement-badge:hover { border-color: var(--primary-green); transform: translateY(-3px); }
        .achievement-badge.unlocked { background: linear-gradient(135deg, #e3fcef 0%, #f0fdf4 100%);
                                     border-color: var(--primary-green); }
        .achievement-icon { font-size: 2rem; margin-bottom: 10px; }
        .achievement-badge.locked { opacity: 0.5; }

        /* Tips */
        .tip-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;
                   display: flex; align-items: start; gap: 15px; }
        .tip-icon { font-size: 1.5rem; color: var(--primary-green); min-width: 30px; }
    </style>
</head>
<body>

<!-- AUTH VIEW -->
<div id="auth-view" class="auth-wrapper">
    <div class="auth-container">
        <div class="info-side">
            <h1>EcoBazaar</h1>
            <p>Shop sustainably. Track your carbon impact. Make a difference.</p>
            <button class="btn btn-outline" style="color: white; border-color: white; margin-top: 20px;"
                    onclick="toggleAuthMode()">Sign Up</button>
        </div>
        <div class="form-side">
            <!-- Login -->
            <div id="loginForm">
                <h2 style="text-align: center; color: var(--dark-green); margin-bottom: 30px;">Sign In</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
                </form>
            </div>

            <!-- Register -->
            <div id="registerForm" class="hidden">
                <h2 style="text-align: center; color: var(--dark-green); margin-bottom: 30px;">Create Account</h2>
                <form onsubmit="handleRegister(event)">
                    <div class="input-group">
                        <label>Full Name</label>
                        <input type="text" name="fullName" required>
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" name="password" required>
                    </div>
                    <div class="input-group">
                        <label>I am a...</label>
                        <select name="role">
                            <option value="USER">Shopper</option>
                            <option value="SELLER">Seller</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- APP VIEW -->
<div id="app-view" class="app-container hidden">
    <nav class="navbar">
        <div class="logo"><i class="fas fa-leaf"></i> EcoBazaar</div>
        <div class="nav-links" id="navLinks"></div>
        <div>
            <span id="userName" style="margin-right: 15px;">User</span>
            <button onclick="logout()" class="btn btn-outline" style="padding: 5px 10px; font-size: 0.8rem;">Logout</button>
        </div>
    </nav>

    <div class="main-content">
        <!-- Shop Section -->
        <div id="shop-section" class="section">
            <h2>Eco-Friendly Products</h2>
            <div id="productsGrid" class="products-grid"></div>
        </div>

        <!-- Cart Section -->
        <div id="cart-section" class="section hidden">
            <h2>Your Cart</h2>
            <div id="cartItems"></div>
            <div style="margin-top: 20px;">
                <h3>Total: $<span id="cartTotal">0.00</span></h3>
                <button class="btn btn-primary" onclick="checkout()">Place Order</button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section hidden">
            <h2>Your Carbon Impact Dashboard</h2>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Carbon Trend Chart -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 30px;">
                <h3>Your Carbon Footprint Over Time</h3>
                <canvas id="carbonTrendChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- Category Breakdown -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                <div style="background: white; padding: 20px; border-radius: 12px;">
                    <h3>Carbon by Category</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px;">
                    <h3>Eco Rating Distribution</h3>
                    <canvas id="ecoRatingChart"></canvas>
                </div>
            </div>

            <!-- Recent Orders -->
            <div style="margin-top: 30px;">
                <h3>Recent Orders</h3>
                <div id="userOrders"></div>
            </div>

            <!-- Achievements -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 30px;">
                <h3>üèÜ Your Achievements</h3>
                <div id="achievements" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;"></div>
            </div>

            <!-- Carbon Savings Tips -->
            <div style="background: linear-gradient(135deg, #e3fcef 0%, #f0fdf4 100%); padding: 20px; border-radius: 12px; margin-top: 30px; border-left: 4px solid var(--primary-green);">
                <h3>üí° Your Personalized Tips</h3>
                <div id="carbonTips"></div>
            </div>
        </div>

        <!-- Seller Section -->
        <div id="seller-section" class="section hidden">
            <h2>Seller Dashboard</h2>
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                <h3>Add New Product</h3>
                <form onsubmit="addProduct(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="input-group">
                        <label>Name</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="input-group">
                        <label>Price</label>
                        <input type="number" step="0.01" name="price" required>
                    </div>
                    <div class="input-group">
                        <label>Category</label>
                        <input type="text" name="category" required>
                    </div>
                    <div class="input-group">
                        <label>Image URL</label>
                        <input type="text" name="imageUrl">
                    </div>
                    <div class="input-group" style="grid-column: span 2;">
                        <label>Description</label>
                        <textarea name="description" required></textarea>
                    </div>
                    <div class="input-group">
                        <label>Manufacturing CO2</label>
                        <input type="number" step="0.1" name="manufacturing" required>
                    </div>
                    <div class="input-group">
                        <label>Transportation CO2</label>
                        <input type="number" step="0.1" name="transportation" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="grid-column: span 2;">Add Product</button>
                </form>
            </div>
            <h3>My Products</h3>
            <div id="sellerProducts"></div>
        </div>

        <!-- Admin Section -->
        <div id="admin-section" class="section hidden">
            <h2>Admin Dashboard</h2>
            <h3>Pending Verifications</h3>
            <table class="data-table">
                <thead><tr><th>Product</th><th>Seller</th><th>Carbon</th><th>Action</th></tr></thead>
                <tbody id="pendingProducts"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let products = [];

    // AUTH
    let isLogin = true;
    function toggleAuthMode() {
        isLogin = !isLogin;
        document.getElementById('loginForm').classList.toggle('hidden');
        document.getElementById('registerForm').classList.toggle('hidden');
    }

    async function handleLogin(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            email: formData.get('email'),
            password: formData.get('password')
        };

        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (res.ok) {
                currentUser = await res.json();
                showApp();
            } else {
                alert('Login failed');
            }
        } catch (e) { alert('Error: ' + e.message); }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            fullName: formData.get('fullName'),
            email: formData.get('email'),
            password: formData.get('password'),
            role: formData.get('role')
        };

        try {
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert('Registration successful! Please login.');
                toggleAuthMode();
            } else {
                const error = await res.json();
                alert(error.error);
            }
        } catch (e) { alert('Error: ' + e.message); }
    }

    function showApp() {
        document.getElementById('auth-view').classList.add('hidden');
        document.getElementById('app-view').classList.remove('hidden');
        document.getElementById('userName').textContent = currentUser.fullName;
        setupNav();
        loadShop();
    }

    function logout() {
        currentUser = null;
        document.getElementById('app-view').classList.add('hidden');
        document.getElementById('auth-view').classList.remove('hidden');
    }

    // NAVIGATION
    function setupNav() {
        const nav = document.getElementById('navLinks');
        let links = '<div class="nav-item active" onclick="switchView(\'shop\')">Shop</div>';

        if (currentUser.role === 'USER') {
            links += '<div class="nav-item" onclick="switchView(\'cart\')">Cart</div>';
            links += '<div class="nav-item" onclick="switchView(\'dashboard\')">Dashboard</div>';
        } else if (currentUser.role === 'SELLER') {
            links += '<div class="nav-item" onclick="switchView(\'seller\')">My Products</div>';
        } else if (currentUser.role === 'ADMIN') {
            links += '<div class="nav-item" onclick="switchView(\'admin\')">Admin</div>';
        }

        nav.innerHTML = links;
    }

    function switchView(view) {
        document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        document.getElementById(view + '-section').classList.remove('hidden');

        if (view === 'shop') loadShop();
        if (view === 'cart') loadCart();
        if (view === 'dashboard') loadDashboard();
        if (view === 'seller') loadSellerProducts();
        if (view === 'admin') loadPendingProducts();
    }

    // SHOP
    async function loadShop() {
        const res = await fetch('/api/products');
        products = await res.json();

        const grid = document.getElementById('productsGrid');
        grid.innerHTML = products.map(p => `
            <div class="product-card">
                <img src="${p.imageUrl || 'https://via.placeholder.com/200'}" class="product-img" alt="${p.name}">
                <h3>${p.name}</h3>
                <p style="color: #666; font-size: 0.9rem; margin: 5px 0;">${p.category}</p>
                <div style="display: flex; align-items: center; gap: 5px; margin: 10px 0;">
                    <i class="fas fa-leaf" style="color: var(--primary-green);"></i>
                    <span style="font-size: 0.9rem;">${p.carbonFootprint.toFixed(1)} kg CO2e</span>
                    <span class="badge badge-${p.ecoRating.replace('+','-plus')}">${p.ecoRating}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 10px;">
                    <strong style="font-size: 1.2rem;">$${p.price.toFixed(2)}</strong>
                    ${currentUser.role === 'USER' ? `<button class="btn btn-primary" onclick="addToCart(${p.id})">Add</button>` : ''}
                </div>
            </div>
        `).join('');
    }

    // CART
    async function addToCart(productId) {
        try {
            await fetch(`/api/cart/${currentUser.id}/items`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({productId, quantity: 1})
            });
            alert('Added to cart!');
        } catch (e) { alert('Error adding to cart'); }
    }

    async function loadCart() {
        const res = await fetch(`/api/cart/${currentUser.id}`);
        const cart = await res.json();

        const container = document.getElementById('cartItems');
        const totalEl = document.getElementById('cartTotal');

        if (cart.items.length === 0) {
            container.innerHTML = '<p>Your cart is empty.</p>';
            totalEl.textContent = '0.00';
            return;
        }

        let total = 0;
        container.innerHTML = cart.items.map(item => {
            total += item.price * item.quantity;
            return `
                <div style="display: flex; justify-content: space-between; background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div>
                        <strong>${item.productName}</strong><br>
                        <small>${item.carbonFootprint} kg CO2e √ó ${item.quantity}</small>
                    </div>
                    <div style="text-align: right;">
                        <div>$${(item.price * item.quantity).toFixed(2)}</div>
                        <button class="btn btn-outline" onclick="removeFromCart(${item.id})" style="font-size: 0.8rem; padding: 5px 10px;">Remove</button>
                    </div>
                </div>
            `;
        }).join('');
        totalEl.textContent = total.toFixed(2);
    }

    async function removeFromCart(itemId) {
        await fetch(`/api/cart/${currentUser.id}/items/${itemId}`, {method: 'DELETE'});
        loadCart();
    }

    async function checkout() {
        try {
            const res = await fetch(`/api/orders/${currentUser.id}`, {method: 'POST'});
            const order = await res.json();
            alert(`Order placed! Total carbon: ${order.totalCarbonFootprint.toFixed(1)} kg CO2e`);
            loadCart();
        } catch (e) { alert('Checkout error'); }
    }

    // DASHBOARD
    let carbonChart, categoryChart, ecoRatingChart;

    async function loadDashboard() {
        // Load Carbon Report
        const res = await fetch(`/api/carbon/report/${currentUser.id}`);
        const report = await res.json();

        // Stats Cards with enhanced visuals
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <div style="font-size: 3rem;">üåü</div>
                <div class="stat-value">${report.ecoScore}</div>
                <div class="stat-label">Eco Score</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 3rem;">üå±</div>
                <div class="stat-value">${report.carbonSaved.toFixed(1)} kg</div>
                <div class="stat-label">Carbon Saved</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 3rem;">üèÜ</div>
                <div class="stat-value">${report.badge}</div>
                <div class="stat-label">Current Badge</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 3rem;">üõçÔ∏è</div>
                <div class="stat-value">${report.greenPurchases}</div>
                <div class="stat-label">Green Purchases</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 3rem;">üì¶</div>
                <div class="stat-value">${report.totalOrders}</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 3rem;">‚ôªÔ∏è</div>
                <div class="stat-value">${report.totalCarbonFootprint.toFixed(1)} kg</div>
                <div class="stat-label">Total CO2 Impact</div>
            </div>
        `;

        // Load Orders for Charts
        const ordersRes = await fetch(`/api/orders/user/${currentUser.id}`);
        const orders = await ordersRes.json();

        // Render Charts
        renderCarbonTrendChart(orders);
        renderCategoryBreakdown(orders);
        renderEcoRatingChart(orders);

        // Render Orders Table
        renderOrdersTable(orders);

        // Render Achievements
        renderAchievements(report);

        // Render Personalized Tips
        renderCarbonTips(report, orders);
    }

    function renderCarbonTrendChart(orders) {
        const ctx = document.getElementById('carbonTrendChart');

        // Destroy previous chart if exists
        if (carbonChart) carbonChart.destroy();

        // Group orders by month
        const monthlyData = {};
        orders.forEach(order => {
            const date = new Date(order.createdAt);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = { carbon: 0, count: 0 };
            }
            monthlyData[monthKey].carbon += order.totalCarbonFootprint;
            monthlyData[monthKey].count += 1;
        });

        const labels = Object.keys(monthlyData).sort();
        const carbonData = labels.map(key => monthlyData[key].carbon);

        carbonChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels.map(l => {
                    const [year, month] = l.split('-');
                    return new Date(year, month - 1).toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
                }),
                datasets: [{
                    label: 'Carbon Footprint (kg CO2e)',
                    data: carbonData,
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true, position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    async function renderCategoryBreakdown(orders) {
        const ctx = document.getElementById('categoryChart');

        if (categoryChart) categoryChart.destroy();

        // Get all order items and group by category
        const categoryData = {};

        for (const order of orders) {
            const detailsRes = await fetch(`/api/orders/${order.id}`);
            const details = await detailsRes.json();

            for (const item of details.items) {
                // Fetch product to get category (in real app, include in order snapshot)
                const productRes = await fetch(`/api/products`);
                const products = await productRes.json();
                const product = products.find(p => p.name === item.productName);
                const category = product ? product.category : 'Unknown';

                if (!categoryData[category]) {
                    categoryData[category] = 0;
                }
                categoryData[category] += item.carbon * item.quantity;
            }
        }

        const categories = Object.keys(categoryData);
        const values = Object.values(categoryData);

        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#2ecc71', '#3498db', '#9b59b6', '#e74c3c', '#f39c12',
                        '#1abc9c', '#34495e', '#e67e22', '#95a5a6'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });
    }

    async function renderEcoRatingChart(orders) {
        const ctx = document.getElementById('ecoRatingChart');

        if (ecoRatingChart) ecoRatingChart.destroy();

        const ratingCounts = { 'A+': 0, 'B': 0, 'C': 0 };

        for (const order of orders) {
            const detailsRes = await fetch(`/api/orders/${order.id}`);
            const details = await detailsRes.json();

            for (const item of details.items) {
                const carbon = item.carbon;
                if (carbon < 2.0) ratingCounts['A+']++;
                else if (carbon < 5.0) ratingCounts['B']++;
                else ratingCounts['C']++;
            }
        }

        ecoRatingChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['A+ (Excellent)', 'B (Good)', 'C (Average)'],
                datasets: [{
                    label: 'Number of Products',
                    data: [ratingCounts['A+'], ratingCounts['B'], ratingCounts['C']],
                    backgroundColor: ['#00b894', '#ffeaa7', '#fab1a0']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
    }

    function renderOrdersTable(orders) {
        document.getElementById('userOrders').innerHTML = orders.length ?
            `<table class="data-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Carbon Impact</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>${orders.map(o => `
                    <tr>
                        <td>#${o.id}</td>
                        <td>${new Date(o.createdAt).toLocaleDateString()}</td>
                        <td>${o.itemCount}</td>
                        <td>${o.totalAmount.toFixed(2)}</td>
                        <td>
                            <span style="color: ${o.totalCarbonFootprint < 5 ? '#00b894' : '#fab1a0'};">
                                ${o.totalCarbonFootprint.toFixed(1)} kg CO2e
                            </span>
                        </td>
                        <td><span class="badge badge-A-plus">${o.status}</span></td>
                    </tr>
                `).join('')}</tbody>
            </table>` : '<p>No orders yet. Start shopping to see your impact!</p>';
    }

    function renderAchievements(report) {
        const achievements = [
            { id: 'first_order', icon: 'üéØ', name: 'First Step', desc: 'Place your first order', unlocked: report.totalOrders >= 1 },
            { id: 'eco_starter', icon: 'üå±', name: 'Eco Starter', desc: 'Earn 100 eco points', unlocked: report.ecoScore >= 100 },
            { id: 'green_shopper', icon: 'üõçÔ∏è', name: 'Green Shopper', desc: '5 green purchases', unlocked: report.greenPurchases >= 5 },
            { id: 'carbon_saver', icon: '‚ôªÔ∏è', name: 'Carbon Saver', desc: 'Save 10kg CO2e', unlocked: report.carbonSaved >= 10 },
            { id: 'eco_warrior', icon: 'ü¶∏', name: 'Eco Warrior', desc: 'Earn 500 eco points', unlocked: report.ecoScore >= 500 },
            { id: 'planet_hero', icon: 'üåç', name: 'Planet Hero', desc: 'Save 50kg CO2e', unlocked: report.carbonSaved >= 50 },
            { id: 'legend', icon: 'üëë', name: 'Eco Legend', desc: 'Earn 1000 eco points', unlocked: report.ecoScore >= 1000 },
            { id: 'master', icon: 'üèÜ', name: 'Sustainability Master', desc: 'Save 100kg CO2e', unlocked: report.carbonSaved >= 100 }
        ];

        document.getElementById('achievements').innerHTML = achievements.map(a => `
            <div class="achievement-badge ${a.unlocked ? 'unlocked' : 'locked'}">
                <div class="achievement-icon">${a.icon}</div>
                <strong style="display: block; margin-bottom: 5px;">${a.name}</strong>
                <small style="color: #666;">${a.desc}</small>
                ${a.unlocked ? '<div style="margin-top: 10px; color: var(--primary-green); font-weight: bold;">‚úì Unlocked</div>' : ''}
            </div>
        `).join('');
    }

    function renderCarbonTips(report, orders) {
        const tips = [];

        if (report.greenPurchases < 3) {
            tips.push({ icon: 'üåø', text: 'Try choosing products with A+ eco rating to maximize your carbon savings!' });
        }

        if (report.totalOrders > 0 && report.carbonSaved < 5) {
            tips.push({ icon: 'üîç', text: 'Look for products with lower carbon footprints in the same category to increase savings.' });
        }

        if (orders.length > 0) {
            const avgCarbon = report.totalCarbonFootprint / orders.length;
            if (avgCarbon > 5) {
                tips.push({ icon: 'üìä', text: `Your average carbon per order is ${avgCarbon.toFixed(1)}kg. Try bulk buying to reduce packaging impact!` });
            }
        }

        if (report.ecoScore < 100) {
            tips.push({ icon: '‚≠ê', text: 'Keep making eco-friendly choices to unlock the "Eco Starter" achievement!' });
        }

        tips.push({ icon: 'üíö', text: 'Every green purchase you make helps reduce global carbon emissions!' });

        document.getElementById('carbonTips').innerHTML = tips.map(t => `
            <div class="tip-item">
                <div class="tip-icon">${t.icon}</div>
                <div>${t.text}</div>
            </div>
        `).join('');
    }

    // SELLER
    async function addProduct(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            sellerId: currentUser.id,
            name: formData.get('name'),
            description: formData.get('description'),
            price: parseFloat(formData.get('price')),
            category: formData.get('category'),
            imageUrl: formData.get('imageUrl'),
            manufacturing: parseFloat(formData.get('manufacturing')),
            transportation: parseFloat(formData.get('transportation')),
            packaging: 0,
            usage: 0,
            disposal: 0
        };

        await fetch('/api/products/seller/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        alert('Product submitted for verification!');
        e.target.reset();
        loadSellerProducts();
    }

    async function loadSellerProducts() {
        const res = await fetch(`/api/products/seller/${currentUser.id}`);
        const products = await res.json();

        document.getElementById('sellerProducts').innerHTML = products.length ?
            `<table class="data-table">
                <thead><tr><th>Name</th><th>Status</th><th>Price</th><th>Carbon</th></tr></thead>
                <tbody>${products.map(p => `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.verified ? '<span class="badge badge-A-plus">Verified</span>' : '<span class="badge badge-B">Pending</span>'}</td>
                        <td>$${p.price.toFixed(2)}</td>
                        <td>${p.carbonFootprint.toFixed(1)} kg</td>
                    </tr>
                `).join('')}</tbody>
            </table>` : '<p>No products yet.</p>';
    }

    // ADMIN
    async function loadPendingProducts() {
        const res = await fetch('/api/products/admin/pending');
        const products = await res.json();

        document.getElementById('pendingProducts').innerHTML = products.length ?
            products.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.sellerName}</td>
                    <td>${p.carbonFootprint.toFixed(1)} kg</td>
                    <td><button class="btn btn-primary" onclick="verifyProduct(${p.id})">Verify</button></td>
                </tr>
            `).join('') : '<tr><td colspan="4">No pending products</td></tr>';
    }

    async function verifyProduct(id) {
        await fetch(`/api/products/admin/verify/${id}?adminId=${currentUser.id}`, {method: 'PUT'});
        loadPendingProducts();
    }
</script>
</body>
</html>