<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoBazaar - Sustainable Shopping Made Easy</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --bg: #f9fafb;
            --text: #1f2937;
            --border: #e5e7eb;
            --card-bg: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
               background: var(--bg); color: var(--text); line-height: 1.6; }
        .hidden { display: none !important; }

        /* Header */
        .header { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 100; }
        .header-top { background: var(--primary); color: white; padding: 8px 0; font-size: 0.85rem; text-align: center; }
        .header-main { max-width: 1400px; margin: 0 auto; padding: 15px 30px; display: flex; align-items: center; gap: 30px; }
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .logo i { font-size: 2rem; }
        .search-bar { flex: 1; max-width: 600px; position: relative; }
        .search-bar input { width: 100%; padding: 12px 50px 12px 20px; border: 2px solid var(--border);
                           border-radius: 25px; font-size: 0.95rem; transition: 0.2s; }
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
        .search-bar button { position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
                            background: var(--primary); color: white; border: none; padding: 8px 20px;
                            border-radius: 20px; cursor: pointer; font-weight: 600; }
        .header-icons { display: flex; gap: 25px; align-items: center; }
        .header-icon { position: relative; cursor: pointer; color: var(--text); font-size: 1.3rem; }
        .header-icon .badge { position: absolute; top: -8px; right: -8px; background: var(--danger);
                             color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; }

        /* Navigation */
        .nav { background: white; border-bottom: 1px solid var(--border); }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 30px; display: flex; gap: 30px; }
        .nav-item { padding: 15px 0; cursor: pointer; color: var(--text); font-weight: 600;
                   position: relative; transition: 0.2s; }
        .nav-item:hover { color: var(--primary); }
        .nav-item.active { color: var(--primary); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0;
                                  height: 3px; background: var(--primary); }

        /* Main Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }

        /* Filters */
        .filters { background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .filters-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .filter-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: #6b7280; }
        .filter-group select, .filter-group input { width: 100%; padding: 10px; border: 1px solid var(--border);
                                                     border-radius: 8px; font-size: 0.95rem; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
               transition: 0.2s; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }

        /* Products Grid */
        .products-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                       transition: 0.3s; cursor: pointer; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .product-img { height: 250px; background: #f3f4f6; overflow: hidden; position: relative; }
        .product-img img { width: 100%; height: 100%; object-fit: cover; }
        .product-badge { position: absolute; top: 10px; left: 10px; padding: 4px 10px; border-radius: 6px;
                        font-size: 0.75rem; font-weight: 700; }
        .badge-featured { background: #fbbf24; color: #78350f; }
        .badge-A-plus { background: #10b981; color: white; }
        .badge-B { background: #f59e0b; color: white; }
        .badge-C { background: #ef4444; color: white; }
        .wishlist-btn { position: absolute; top: 10px; right: 10px; background: white; border: none;
                       width: 36px; height: 36px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .wishlist-btn i { color: #9ca3af; transition: 0.2s; }
        .wishlist-btn.active i { color: #ef4444; }
        .product-info { padding: 15px; }
        .product-name { font-weight: 700; font-size: 1.05rem; margin-bottom: 8px; }
        .product-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.85rem; color: #6b7280; }
        .product-carbon { display: flex; align-items: center; gap: 5px; color: var(--primary); font-weight: 600; }
        .product-rating { display: flex; align-items: center; gap: 5px; }
        .product-rating .stars { color: #fbbf24; }
        .product-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 10px;
                         border-top: 1px solid var(--border); }
        .product-price { font-size: 1.4rem; font-weight: 800; color: var(--primary); }

        /* Pagination */
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 40px; }
        .page-btn { padding: 8px 16px; border: 1px solid var(--border); background: white; border-radius: 8px;
                   cursor: pointer; font-weight: 600; transition: 0.2s; }
        .page-btn:hover { background: var(--primary); color: white; }
        .page-btn.active { background: var(--primary); color: white; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
                display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh;
                        overflow-y: auto; animation: modalSlide 0.3s; }
        @keyframes modalSlide { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex;
                       justify-content: space-between; align-items: center; }
        .modal-body { padding: 30px; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af; }

        /* Product Detail */
        .product-detail { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .product-images { }
        .main-image { width: 100%; height: 400px; background: #f3f4f6; border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
        .main-image img { width: 100%; height: 100%; object-fit: cover; }
        .thumbnail-images { display: flex; gap: 10px; }
        .thumbnail { width: 80px; height: 80px; border-radius: 8px; overflow: hidden; cursor: pointer; border: 2px solid transparent; }
        .thumbnail.active { border-color: var(--primary); }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .product-details h1 { font-size: 1.8rem; margin-bottom: 10px; }
        .product-stats { display: flex; gap: 20px; margin: 15px 0; padding: 15px 0; border-top: 1px solid var(--border);
                        border-bottom: 1px solid var(--border); }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.85rem; color: #6b7280; }
        .carbon-breakdown { background: #f0fdf4; padding: 20px; border-radius: 12px; margin: 20px 0; }
        .carbon-bar { display: flex; height: 30px; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .carbon-segment { display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600; }

        /* Reviews */
        .reviews-section { margin-top: 30px; padding-top: 30px; border-top: 1px solid var(--border); }
        .review-card { background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .reviewer-name { font-weight: 700; }
        .review-stars { color: #fbbf24; }

        /* Cart */
        .cart-item { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; display: flex; gap: 20px; }
        .cart-item-img { width: 100px; height: 100px; border-radius: 8px; overflow: hidden; }
        .cart-item-img img { width: 100%; height: 100%; object-fit: cover; }
        .cart-item-info { flex: 1; }
        .cart-item-actions { display: flex; align-items: center; gap: 10px; }
        .qty-control { display: flex; align-items: center; gap: 10px; background: #f3f4f6; padding: 5px; border-radius: 8px; }
        .qty-btn { background: white; border: none; width: 30px; height: 30px; border-radius: 6px; cursor: pointer; font-weight: 700; }

        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-card .icon { font-size: 2.5rem; margin-bottom: 15px; }
        .stat-card .value { font-size: 2rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .stat-card .label { color: #6b7280; font-size: 0.95rem; }

        /* Toast Notification */
        .toast { position: fixed; bottom: 30px; right: 30px; background: white; padding: 15px 25px; border-radius: 12px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 2000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

        /* Responsive */
        @media (max-width: 768px) {
            .header-main { flex-wrap: wrap; }
            .search-bar { width: 100%; order: 3; }
            .products-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .product-detail { grid-template-columns: 1fr; }
            .filters-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- AUTH VIEW -->
<div id="authView">
    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-width: 450px; width: 90%;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 3rem; color: #10b981; margin-bottom: 10px;"><i class="fas fa-leaf"></i></div>
                <h1 style="color: #10b981; margin-bottom: 10px;">EcoBazaar</h1>
                <p style="color: #6b7280;">Shop sustainably, track your carbon impact</p>
            </div>

            <!-- Login Form -->
            <form id="loginForm" onsubmit="handleLogin(event)">
                <h2 style="margin-bottom: 20px;">Sign In</h2>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email</label>
                    <input type="email" name="email" required style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Password</label>
                    <input type="password" name="password" required style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Sign In</button>
                <p style="text-align: center; margin-top: 15px;">
                    Don't have an account? <a href="#" onclick="toggleAuthMode(); return false;" style="color: var(--primary); font-weight: 600;">Sign Up</a>
                </p>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
                <h2 style="margin-bottom: 20px;">Create Account</h2>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Full Name</label>
                    <input type="text" name="fullName" required style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email</label>
                    <input type="email" name="email" required style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Password</label>
                    <input type="password" name="password" required style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">I am a...</label>
                    <select name="role" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
                        <option value="USER">Shopper</option>
                        <option value="SELLER">Seller</option>
                        <option value="ADMIN">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Sign Up</button>
                <p style="text-align: center; margin-top: 15px;">
                    Already have an account? <a href="#" onclick="toggleAuthMode(); return false;" style="color: var(--primary); font-weight: 600;">Sign In</a>
                </p>
            </form>
        </div>
    </div>
</div>

<!-- APP VIEW -->
<div id="appView" class="hidden">
    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <div><i class="fas fa-leaf"></i> Free carbon-neutral shipping on orders over $50 | Shop Green, Save the Planet</div>
        </div>
        <div class="header-main">
            <div class="logo"><i class="fas fa-leaf"></i> EcoBazaar</div>
            <div class="search-bar">
                <input type="text" placeholder="Search for eco-friendly products..." id="headerSearch">
                <button onclick="searchFromHeader()"><i class="fas fa-search"></i></button>
            </div>
            <div class="header-icons">
                <div class="header-icon" onclick="showWishlist()" title="Wishlist">
                    <i class="fas fa-heart"></i>
                    <span class="badge" id="wishlistCount">0</span>
                </div>
                <div class="header-icon" onclick="switchView('cart')" title="Cart">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="badge" id="cartCount">0</span>
                </div>
                <div class="header-icon">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span id="userName" style="font-size: 0.9rem; font-weight: 600;"></span>
                        <button onclick="logout()" class="btn btn-outline" style="padding: 6px 15px; font-size: 0.85rem;">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container" id="navContainer"></div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <!-- Shop Section -->
        <section id="shopSection" class="section">
            <!-- Filters -->
            <div class="filters">
                <div class="filters-row">
                    <div class="filter-group">
                        <label>Category</label>
                        <select id="filterCategory">
                            <option value="All">All Categories</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Sort By</label>
                        <select id="filterSort">
                            <option value="newest">Newest First</option>
                            <option value="price_asc">Price: Low to High</option>
                            <option value="price_desc">Price: High to Low</option>
                            <option value="rating">Highest Rated</option>
                            <option value="popular">Most Popular</option>
                            <option value="carbon_asc">Lowest Carbon</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Max Price</label>
                        <input type="number" id="filterMaxPrice" placeholder="Any">
                    </div>
                    <div class="filter-group">
                        <label>Max Carbon (kg)</label>
                        <input type="number" id="filterMaxCarbon" placeholder="Any">
                    </div>
                    <div class="filter-group" style="display: flex; align-items: end;">
                        <button class="btn btn-primary" onclick="applyFilters()" style="width: 100%;"><i class="fas fa-filter"></i> Apply</button>
                    </div>
                </div>
            </div>

            <!-- Featured Products -->
            <div id="featuredSection" style="margin-bottom: 40px;"></div>

            <!-- Products -->
            <div class="products-header">
                <h2>All Products</h2>
                <div id="productsCount"></div>
            </div>
            <div id="productsGrid" class="products-grid"></div>
            <div id="pagination" class="pagination"></div>
        </section>

        <!-- Cart Section -->
        <section id="cartSection" class="section hidden">
            <h2 style="margin-bottom: 20px;">Shopping Cart</h2>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                <div id="cartItems"></div>
                <div>
                    <div style="background: white; padding: 25px; border-radius: 12px; position: sticky; top: 100px;">
                        <h3 style="margin-bottom: 20px;">Order Summary</h3>
                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Subtotal</span>
                                <strong>$<span id="cartSubtotal">0.00</span></strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--primary);">
                                <span><i class="fas fa-leaf"></i> Total Carbon</span>
                                <strong><span id="cartCarbon">0</span> kg CO2e</strong>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="checkout()" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                            <i class="fas fa-check"></i> Checkout
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboardSection" class="section hidden">
            <h2 style="margin-bottom: 20px;">Your Eco Dashboard</h2>
            <div class="stats-grid" id="dashboardStats"></div>
            <div style="background: white; padding: 25px; border-radius: 12px; margin-top: 30px;">
                <h3 style="margin-bottom: 20px;">Your Carbon Journey</h3>
                <canvas id="carbonChart" style="max-height: 300px;"></canvas>
            </div>
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 20px;">Recent Orders</h3>
                <div id="recentOrders"></div>
            </div>
        </section>

        <!-- Wishlist Section -->
        <section id="wishlistSection" class="section hidden">
            <h2 style="margin-bottom: 20px;">My Wishlist</h2>
            <div id="wishlistGrid" class="products-grid"></div>
        </section>

        <!-- Seller Section -->
        <section id="sellerSection" class="section hidden">
            <h2 style="margin-bottom: 20px;">Seller Dashboard</h2>
            <div class="stats-grid" id="sellerStats"></div>

            <div style="background: white; padding: 25px; border-radius: 12px; margin: 30px 0;">
                <h3 style="margin-bottom: 20px;">Add/Edit Product</h3>
                <form id="productForm" onsubmit="handleProductSubmit(event)">
                    <input type="hidden" id="editProductId">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Product Name</label>
                            <input type="text" id="prodName" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Price ($)</label>
                            <input type="number" step="0.01" id="prodPrice" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Quantity</label>
                            <input type="number" id="prodQuantity" value="1" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Category</label>
                            <select id="prodCategory" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;"></select>
                        </div>
                        <div style="grid-column: span 2;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Description</label>
                            <textarea id="prodDesc" required rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;"></textarea>
                        </div>
                        <div style="grid-column: span 2;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Product Images</label>
                            <input type="file" id="productImages" multiple accept="image/*" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                            <small style="color: #6b7280;">Upload up to 5 images</small>
                        </div>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="margin-bottom: 15px;">Carbon Footprint Data (Optional)</h4>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.85rem;">Manufacturing</label>
                                <input type="number" step="0.1" id="prodManu" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.85rem;">Transport</label>
                                <input type="number" step="0.1" id="prodTrans" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.85rem;">Packaging</label>
                                <input type="number" step="0.1" id="prodPack" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.85rem;">Usage</label>
                                <input type="number" step="0.1" id="prodUsage" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.85rem;">Disposal</label>
                                <input type="number" step="0.1" id="prodDisp" value="0" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                        </div>
                        <small style="color: #6b7280; display: block; margin-top: 10px;">Leave at 0 for automatic calculation based on category</small>
                    </div>
                    <button type="submit" class="btn btn-primary" id="productSubmitBtn"><i class="fas fa-plus"></i> Add Product</button>
                    <button type="button" class="btn btn-outline hidden" id="cancelEditBtn" onclick="cancelEdit()" style="margin-left: 10px;">Cancel</button>
                </form>
            </div>

            <h3 style="margin-bottom: 20px;">My Products</h3>
            <div id="sellerProducts"></div>
        </section>

        <!-- Admin Section -->
        <section id="adminSection" class="section hidden">
            <h2 style="margin-bottom: 20px;">Admin Dashboard</h2>
            <div class="stats-grid" id="adminStats"></div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Pending Verifications</h3>
            <div id="pendingProducts"></div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">All Products</h3>
            <div id="adminProducts"></div>
        </section>
    </main>
</div>

<!-- Product Detail Modal -->
<div id="productModal" class="modal hidden" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>Product Details</h2>
            <button class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="productDetailContent"></div>
    </div>
</div>

<script>
    let currentUser = null;
    let categories = [];
    let currentPage = 0;
    let totalPages = 0;
    let currentFilters = {};

    // ===== AUTH =====
    function toggleAuthMode() {
        document.getElementById('loginForm').classList.toggle('hidden');
        document.getElementById('registerForm').classList.toggle('hidden');
    }

    async function handleLogin(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    email: formData.get('email'),
                    password: formData.get('password')
                })
            });
            if (res.ok) {
                currentUser = await res.json();
                showApp();
            } else {
                showToast('Login failed', 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    fullName: formData.get('fullName'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    role: formData.get('role')
                })
            });
            if (res.ok) {
                showToast('Registration successful! Please login.', 'success');
                toggleAuthMode();
            } else {
                const error = await res.json();
                showToast(error.error, 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function showApp() {
        document.getElementById('authView').classList.add('hidden');
        document.getElementById('appView').classList.remove('hidden');
        document.getElementById('userName').textContent = currentUser.fullName;

        await loadCategories();
        setupNav();
        loadProducts();
        updateCartCount();
        updateWishlistCount();
    }

    function logout() {
        currentUser = null;
        document.getElementById('appView').classList.add('hidden');
        document.getElementById('authView').classList.remove('hidden');
    }

    // ===== NAVIGATION =====
    function setupNav() {
        const nav = document.getElementById('navContainer');
        let items = '<div class="nav-item active" onclick="switchView(\'shop\')">Shop</div>';

        if (currentUser.role === 'USER') {
            items += '<div class="nav-item" onclick="switchView(\'cart\')">Cart</div>';
            items += '<div class="nav-item" onclick="switchView(\'dashboard\')">Dashboard</div>';
            items += '<div class="nav-item" onclick="switchView(\'wishlist\')">Wishlist</div>';
        } else if (currentUser.role === 'SELLER') {
            items += '<div class="nav-item" onclick="switchView(\'seller\')">My Products</div>';
            items += '<div class="nav-item" onclick="switchView(\'shop\')">Browse Products</div>';
        } else if (currentUser.role === 'ADMIN') {
            items += '<div class="nav-item" onclick="switchView(\'admin\')">Admin Panel</div>';
            items += '<div class="nav-item" onclick="switchView(\'shop\')">Browse Products</div>';
        }

        nav.innerHTML = items;
    }

    function switchView(view) {
        document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        const section = document.getElementById(view + 'Section');
        if (section) section.classList.remove('hidden');

        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            if (item.textContent.toLowerCase().includes(view) ||
                (view === 'shop' && item.textContent === 'Shop') ||
                (view === 'cart' && item.textContent === 'Cart')) {
                item.classList.add('active');
            }
        });

        if (view === 'shop') loadProducts();
        if (view === 'cart') loadCart();
        if (view === 'dashboard') loadDashboard();
        if (view === 'wishlist') loadWishlist();
        if (view === 'seller') loadSellerDashboard();
        if (view === 'admin') loadAdminDashboard();
    }

    // ===== CATEGORIES =====
    async function loadCategories() {
        try {
            const res = await fetch('/api/categories');
            categories = await res.json();

            // Populate filter dropdowns
            const categorySelect = document.getElementById('filterCategory');
            const prodCategorySelect = document.getElementById('prodCategory');

            let options = '<option value="All">All Categories</option>';
            categories.forEach(cat => {
                options += `<option value="${cat.name}">${cat.name}</option>`;
            });

            if (categorySelect) categorySelect.innerHTML = options;
            if (prodCategorySelect) prodCategorySelect.innerHTML = options.replace('<option value="All">All Categories</option>', '');
        } catch (e) {
            console.error('Error loading categories:', e);
        }
    }

    // ===== PRODUCTS =====
    async function loadProducts(page = 0) {
        try {
            const category = document.getElementById('filterCategory')?.value;
            const sortBy = document.getElementById('filterSort')?.value;
            const maxPrice = document.getElementById('filterMaxPrice')?.value;
            const maxCarbon = document.getElementById('filterMaxCarbon')?.value;
            const search = document.getElementById('headerSearch')?.value;

            let url = `/api/products?page=${page}&size=12`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (category && category !== 'All') url += `&category=${encodeURIComponent(category)}`;
            if (sortBy) url += `&sortBy=${sortBy}`;
            if (maxPrice) url += `&maxPrice=${maxPrice}`;
            if (maxCarbon) url += `&maxCarbon=${maxCarbon}`;

            const res = await fetch(url);
            const data = await res.json();

            currentPage = data.currentPage;
            totalPages = data.totalPages;

            renderProducts(data.products);
            renderPagination();

            document.getElementById('productsCount').textContent =
                `Showing ${data.products.length} of ${data.totalItems} products`;

            // Load featured products
            if (page === 0) await loadFeaturedProducts();

        } catch (e) {
            console.error('Error loading products:', e);
            showToast('Error loading products', 'error');
        }
    }

    function renderProducts(products) {
        const grid = document.getElementById('productsGrid');
        if (products.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #9ca3af;"><i class="fas fa-box-open" style="font-size: 4rem; margin-bottom: 20px; display: block;"></i><h3>No products found</h3><p>Try adjusting your filters</p></div>';
            return;
        }

        grid.innerHTML = products.map(p => `
            <div class="product-card" onclick="showProductDetail(${p.id})">
                <div class="product-img">
                    <img src="${p.primaryImage}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/300'">
                    ${p.featured ? '<div class="product-badge badge-featured"><i class="fas fa-star"></i> Featured</div>' : ''}
                    <div class="product-badge badge-${p.ecoRating.replace('+', '-plus')}" style="top: ${p.featured ? '50px' : '10px'};">${p.ecoRating}</div>
                </div>
                ${currentUser.role === 'USER' ? `
                    <button class="wishlist-btn ${isInWishlist(p.id) ? 'active' : ''}" onclick="event.stopPropagation(); toggleWishlist(${p.id})">
                        <i class="fas fa-heart"></i>
                    </button>
                ` : ''}
                <div class="product-info">
                    <div class="product-name">${p.name}</div>
                    <div class="product-meta">
                        <span class="product-carbon"><i class="fas fa-leaf"></i> ${p.carbonFootprint.toFixed(1)} kg CO2e</span>
                        <div class="product-rating">
                            <span class="stars">
                                ${'★'.repeat(Math.round(p.averageRating))}${'☆'.repeat(5 - Math.round(p.averageRating))}
                            </span>
                            <span style="color: #6b7280;">(${p.reviewCount})</span>
                        </div>
                    </div>
                    <div class="product-footer">
                        <div class="product-price">$${p.price.toFixed(2)}</div>
                        ${currentUser.role === 'USER' && p.quantity > 0 ?
                            `<button class="btn btn-primary" onclick="event.stopPropagation(); addToCart(${p.id})"><i class="fas fa-cart-plus"></i></button>` :
                            (p.quantity === 0 ? '<span style="color: #ef4444; font-size: 0.9rem;">Out of Stock</span>' : '')}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderPagination() {
        const container = document.getElementById('pagination');
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';

        if (currentPage > 0) {
            html += `<button class="page-btn" onclick="loadProducts(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
        }

        for (let i = 0; i < totalPages; i++) {
            if (i === 0 || i === totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadProducts(${i})">${i + 1}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<span style="padding: 8px;">...</span>';
            }
        }

        if (currentPage < totalPages - 1) {
            html += `<button class="page-btn" onclick="loadProducts(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
        }

        container.innerHTML = html;
    }

    async function loadFeaturedProducts() {
        try {
            const res = await fetch('/api/products/featured');
            const featured = await res.json();

            if (featured.length === 0) return;

            const section = document.getElementById('featuredSection');
            section.innerHTML = `
                <h2 style="margin-bottom: 20px;"><i class="fas fa-star" style="color: #fbbf24;"></i> Featured Products</h2>
                <div class="products-grid">
                    ${featured.slice(0, 4).map(p => `
                        <div class="product-card" onclick="showProductDetail(${p.id})">
                            <div class="product-img">
                                <img src="${p.primaryImage}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/300'">
                                <div class="product-badge badge-featured"><i class="fas fa-star"></i> Featured</div>
                                <div class="product-badge badge-${p.ecoRating.replace('+', '-plus')}" style="top: 50px;">${p.ecoRating}</div>
                            </div>
                            ${currentUser.role === 'USER' ? `
                                <button class="wishlist-btn" onclick="event.stopPropagation(); toggleWishlist(${p.id})">
                                    <i class="fas fa-heart"></i>
                                </button>
                            ` : ''}
                            <div class="product-info">
                                <div class="product-name">${p.name}</div>
                                <div class="product-meta">
                                    <span class="product-carbon"><i class="fas fa-leaf"></i> ${p.carbonFootprint.toFixed(1)} kg CO2e</span>
                                    <div class="product-rating">
                                        <span class="stars">
                                            ${'★'.repeat(Math.round(p.averageRating))}${'☆'.repeat(5 - Math.round(p.averageRating))}
                                        </span>
                                        <span style="color: #6b7280;">(${p.reviewCount})</span>
                                    </div>
                                </div>
                                <div class="product-footer">
                                    <div class="product-price">$${p.price.toFixed(2)}</div>
                                    ${currentUser.role === 'USER' && p.quantity > 0 ?
                                        `<button class="btn btn-primary" onclick="event.stopPropagation(); addToCart(${p.id})"><i class="fas fa-cart-plus"></i></button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (e) {
            console.error('Error loading featured products:', e);
        }
    }

    function applyFilters() {
        currentPage = 0;
        loadProducts();
    }

    function searchFromHeader() {
        currentPage = 0;
        switchView('shop');
        loadProducts();
    }

    // ===== PRODUCT DETAIL MODAL =====
    async function showProductDetail(productId) {
        try {
            const res = await fetch(`/api/products/${productId}`);
            const product = await res.json();

            const reviewsRes = await fetch(`/api/reviews/product/${productId}`);
            const reviews = await reviewsRes.json();

            const modal = document.getElementById('productModal');
            const content = document.getElementById('productDetailContent');

            const carbonData = product.carbonBreakdown || {};
            const total = product.carbonFootprint;

            content.innerHTML = `
                <div class="product-detail">
                    <div class="product-images">
                        <div class="main-image">
                            <img id="mainProductImage" src="${product.primaryImage}" alt="${product.name}">
                        </div>
                        <div class="thumbnail-images">
                            ${product.images.map((img, i) => `
                                <div class="thumbnail ${i === 0 ? 'active' : ''}" onclick="changeProductImage('${img}', this)">
                                    <img src="${img}" alt="Image ${i+1}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="product-details">
                        <h1>${product.name}</h1>
                        <div class="product-stats">
                            <div class="stat-item">
                                <div class="stat-value">${product.ecoRating}</div>
                                <div class="stat-label">Eco Rating</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">
                                    ${'★'.repeat(Math.round(product.averageRating))}${'☆'.repeat(5 - Math.round(product.averageRating))}
                                </div>
                                <div class="stat-label">${product.reviewCount} Reviews</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${product.soldCount}</div>
                                <div class="stat-label">Sold</div>
                            </div>
                        </div>
                        <div style="font-size: 2rem; font-weight: 800; color: var(--primary); margin: 20px 0;">
                            ${product.price.toFixed(2)}
                        </div>
                        <p style="margin-bottom: 20px; line-height: 1.8; color: #4b5563;">${product.description}</p>

                        <div class="carbon-breakdown">
                            <h4 style="margin-bottom: 10px;"><i class="fas fa-leaf" style="color: var(--primary);"></i> Carbon Footprint: ${product.carbonFootprint.toFixed(2)} kg CO2e</h4>
                            <div class="carbon-bar">
                                <div class="carbon-segment" style="width: ${(carbonData.manufacturing/total*100)}%; background: #10b981;"
                                     title="Manufacturing: ${carbonData.manufacturing?.toFixed(2)}kg">Mfg</div>
                                <div class="carbon-segment" style="width: ${(carbonData.transportation/total*100)}%; background: #3b82f6;"
                                     title="Transport: ${carbonData.transportation?.toFixed(2)}kg">Trans</div>
                                <div class="carbon-segment" style="width: ${(carbonData.packaging/total*100)}%; background: #f59e0b;"
                                     title="Packaging: ${carbonData.packaging?.toFixed(2)}kg">Pack</div>
                                <div class="carbon-segment" style="width: ${(carbonData.disposal/total*100)}%; background: #ef4444;"
                                     title="Disposal: ${carbonData.disposal?.toFixed(2)}kg">Disp</div>
                            </div>
                        </div>

                        ${currentUser.role === 'USER' ? `
                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button class="btn btn-primary" style="flex: 1; padding: 15px; font-size: 1.1rem;" onclick="addToCart(${product.id}); closeModal();">
                                    <i class="fas fa-cart-plus"></i> Add to Cart
                                </button>
                                <button class="btn btn-outline" style="padding: 15px;" onclick="toggleWishlist(${product.id})">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        ` : ''}

                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                            <p style="color: #6b7280; margin-bottom: 5px;"><i class="fas fa-store"></i> Sold by: <strong>${product.sellerName}</strong></p>
                            <p style="color: #6b7280;"><i class="fas fa-box"></i> In Stock: <strong>${product.quantity}</strong></p>
                        </div>
                    </div>
                </div>

                ${currentUser.role === 'USER' ? `
                    <div class="reviews-section">
                        <h3 style="margin-bottom: 20px;">Customer Reviews</h3>
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px;">Write a Review</h4>
                            <form onsubmit="submitReview(event, ${product.id})">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Rating</label>
                                    <div class="rating-input" style="font-size: 2rem; color: #fbbf24;">
                                        ${[1,2,3,4,5].map(i => `<span onclick="setRating(${i})" style="cursor: pointer;">☆</span>`).join('')}
                                    </div>
                                    <input type="hidden" id="reviewRating" required>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Comment</label>
                                    <textarea id="reviewComment" rows="3" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Review</button>
                            </form>
                        </div>

                        ${reviews.map(r => `
                            <div class="review-card">
                                <div class="review-header">
                                    <div>
                                        <span class="reviewer-name">${r.userName}</span>
                                        ${r.verified ? '<span style="color: var(--primary); margin-left: 10px;"><i class="fas fa-check-circle"></i> Verified Purchase</span>' : ''}
                                    </div>
                                    <div class="review-stars">${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}</div>
                                </div>
                                <p style="color: #4b5563; line-height: 1.6;">${r.comment}</p>
                                <small style="color: #9ca3af; margin-top: 10px; display: block;">${new Date(r.createdAt).toLocaleDateString()}</small>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            modal.classList.remove('hidden');
        } catch (e) {
            console.error('Error loading product details:', e);
            showToast('Error loading product', 'error');
        }
    }

    function changeProductImage(src, element) {
        document.getElementById('mainProductImage').src = src;
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        element.classList.add('active');
    }

    function closeModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('productModal').classList.add('hidden');
        }
    }

    let currentRating = 0;
    function setRating(rating) {
        currentRating = rating;
        document.getElementById('reviewRating').value = rating;
        const stars = document.querySelectorAll('.rating-input span');
        stars.forEach((star, i) => {
            star.textContent = i < rating ? '★' : '☆';
        });
    }

    async function submitReview(e, productId) {
        e.preventDefault();
        try {
            const res = await fetch('/api/reviews', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    userId: currentUser.id,
                    productId: productId,
                    rating: currentRating,
                    comment: document.getElementById('reviewComment').value
                })
            });
            if (res.ok) {
                showToast('Review submitted!', 'success');
                closeModal();
                showProductDetail(productId);
            } else {
                const error = await res.json();
                showToast(error.error, 'error');
            }
        } catch (e) {
            showToast('Error submitting review', 'error');
        }
    }

    // ===== CART =====
    async function addToCart(productId) {
        try {
            const res = await fetch(`/api/cart/${currentUser.id}/items`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({productId, quantity: 1})
            });
            if (res.ok) {
                showToast('Added to cart!', 'success');
                updateCartCount();
            } else {
                showToast('Error adding to cart', 'error');
            }
        } catch (e) {
            showToast('Error adding to cart', 'error');
        }
    }

    async function loadCart() {
        try {
            const res = await fetch(`/api/cart/${currentUser.id}`);
            const cart = await res.json();

            const container = document.getElementById('cartItems');

            if (cart.items.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-shopping-cart" style="font-size: 5rem; color: #e5e7eb; margin-bottom: 20px;"></i>
                        <h2 style="margin-bottom: 10px;">Your cart is empty</h2>
                        <p style="color: #6b7280; margin-bottom: 20px;">Start shopping for eco-friendly products!</p>
                        <button class="btn btn-primary" onclick="switchView('shop')">Browse Products</button>
                    </div>
                `;
                document.getElementById('cartSubtotal').textContent = '0.00';
                document.getElementById('cartCarbon').textContent = '0.0';
                return;
            }

            let total = 0;
            let totalCarbon = 0;

            container.innerHTML = cart.items.map(item => {
                total += item.price * item.quantity;
                totalCarbon += item.carbonFootprint * item.quantity;
                return `
                    <div class="cart-item">
                        <div class="cart-item-img">
                            <img src="${item.imageUrl}" alt="${item.productName}">
                        </div>
                        <div class="cart-item-info">
                            <h3 style="margin-bottom: 5px;">${item.productName}</h3>
                            <p style="color: #6b7280; font-size: 0.9rem;"><i class="fas fa-leaf" style="color: var(--primary);"></i> ${item.carbonFootprint} kg CO2e each</p>
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-top: 10px;">${item.price.toFixed(2)}</div>
                        </div>
                        <div class="cart-item-actions">
                            <div class="qty-control">
                                <button class="qty-btn" onclick="updateCartQuantity(${item.id}, ${item.quantity - 1})">-</button>
                                <span style="min-width: 30px; text-align: center; font-weight: 700;">${item.quantity}</span>
                                <button class="qty-btn" onclick="updateCartQuantity(${item.id}, ${item.quantity + 1})">+</button>
                            </div>
                            <button class="btn btn-danger" onclick="removeFromCart(${item.id})" style="padding: 10px 15px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('cartSubtotal').textContent = total.toFixed(2);
            document.getElementById('cartCarbon').textContent = totalCarbon.toFixed(1);

        } catch (e) {
            console.error('Error loading cart:', e);
        }
    }

    async function updateCartQuantity(itemId, newQty) {
        if (newQty < 1) {
            await removeFromCart(itemId);
            return;
        }
        // For simplicity, remove and re-add with new quantity
        await removeFromCart(itemId);
        // This is a simplification - in production, you'd have an update endpoint
        loadCart();
    }

    async function removeFromCart(itemId) {
        try {
            await fetch(`/api/cart/${currentUser.id}/items/${itemId}`, {method: 'DELETE'});
            loadCart();
            updateCartCount();
        } catch (e) {
            showToast('Error removing item', 'error');
        }
    }

    async function updateCartCount() {
        try {
            const res = await fetch(`/api/cart/${currentUser.id}`);
            const cart = await res.json();
            document.getElementById('cartCount').textContent = cart.items.length;
        } catch (e) {
            console.error('Error updating cart count:', e);
        }
    }

    async function checkout() {
        try {
            const res = await fetch(`/api/orders/${currentUser.id}`, {method: 'POST'});
            const order = await res.json();
            showToast(`Order placed! Total carbon: ${order.totalCarbonFootprint.toFixed(1)} kg CO2e`, 'success');
            updateCartCount();
            switchView('dashboard');
        } catch (e) {
            showToast('Checkout error', 'error');
        }
    }

    // ===== WISHLIST =====
    let wishlistCache = [];

    async function loadWishlist() {
        try {
            const res = await fetch(`/api/wishlist/${currentUser.id}`);
            wishlistCache = await res.json();

            const grid = document.getElementById('wishlistGrid');

            if (wishlistCache.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <i class="fas fa-heart" style="font-size: 5rem; color: #e5e7eb; margin-bottom: 20px;"></i>
                        <h2 style="margin-bottom: 10px;">Your wishlist is empty</h2>
                        <p style="color: #6b7280; margin-bottom: 20px;">Save products you love for later!</p>
                        <button class="btn btn-primary" onclick="switchView('shop')">Browse Products</button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = wishlistCache.map(item => `
                <div class="product-card" onclick="showProductDetail(${item.productId})">
                    <div class="product-img">
                        <img src="${item.image}" alt="${item.productName}">
                        <div class="product-badge badge-${item.ecoRating.replace('+', '-plus')}">${item.ecoRating}</div>
                    </div>
                    <button class="wishlist-btn active" onclick="event.stopPropagation(); toggleWishlist(${item.productId})">
                        <i class="fas fa-heart"></i>
                    </button>
                    <div class="product-info">
                        <div class="product-name">${item.productName}</div>
                        <div class="product-meta">
                            <span class="product-carbon"><i class="fas fa-leaf"></i> ${item.carbonFootprint.toFixed(1)} kg CO2e</span>
                        </div>
                        <div class="product-footer">
                            <div class="product-price">${item.price.toFixed(2)}</div>
                            <button class="btn btn-primary" onclick="event.stopPropagation(); addToCart(${item.productId})"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');

        } catch (e) {
            console.error('Error loading wishlist:', e);
        }
    }

    async function toggleWishlist(productId) {
        try {
            if (isInWishlist(productId)) {
                await fetch(`/api/wishlist/${currentUser.id}/${productId}`, {method: 'DELETE'});
                showToast('Removed from wishlist', 'success');
            } else {
                await fetch(`/api/wishlist/${currentUser.id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({productId})
                });
                showToast('Added to wishlist', 'success');
            }
            await updateWishlistCount();
            if (document.getElementById('wishlistSection').classList.contains('hidden') === false) {
                loadWishlist();
            }
        } catch (e) {
            showToast('Error updating wishlist', 'error');
        }
    }

    function isInWishlist(productId) {
        return wishlistCache.some(item => item.productId === productId);
    }

    async function updateWishlistCount() {
        try {
            const res = await fetch(`/api/wishlist/${currentUser.id}`);
            wishlistCache = await res.json();
            document.getElementById('wishlistCount').textContent = wishlistCache.length;
        } catch (e) {
            console.error('Error updating wishlist count:', e);
        }
    }

    function showWishlist() {
        switchView('wishlist');
    }

    // ===== DASHBOARD =====
    async function loadDashboard() {
        try {
            const res = await fetch(`/api/dashboard/user/${currentUser.id}`);
            const dashboard = await res.json();

            const stats = dashboard.stats;
            document.getElementById('dashboardStats').innerHTML = `
                <div class="stat-card">
                    <div class="icon" style="color: #10b981;"><i class="fas fa-award"></i></div>
                    <div class="value">${stats.ecoScore}</div>
                    <div class="label">Eco Score</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #3b82f6;"><i class="fas fa-leaf"></i></div>
                    <div class="value">${stats.carbonSaved.toFixed(1)} kg</div>
                    <div class="label">Carbon Saved</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #f59e0b;"><i class="fas fa-shopping-bag"></i></div>
                    <div class="value">${stats.totalOrders}</div>
                    <div class="label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #10b981;"><i class="fas fa-trophy"></i></div>
                    <div class="value">${stats.badge}</div>
                    <div class="label">Current Badge</div>
                </div>
            `;

            // Carbon trend chart
            if (dashboard.carbonTrend && dashboard.carbonTrend.labels.length > 0) {
                const ctx = document.getElementById('carbonChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dashboard.carbonTrend.labels,
                        datasets: [{
                            label: 'Carbon Footprint (kg CO2e)',
                            data: dashboard.carbonTrend.carbonData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            }

            // Recent orders
            const ordersContainer = document.getElementById('recentOrders');
            if (dashboard.recentOrders && dashboard.recentOrders.length > 0) {
                ordersContainer.innerHTML = dashboard.recentOrders.map(order => `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Order #${order.orderId}</strong>
                                <p style="color: #6b7280; margin-top: 5px;">${order.itemCount} items · ${new Date(order.orderDate).toLocaleDateString()}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary);">${order.totalAmount.toFixed(2)}</div>
                                <div style="color: #6b7280; font-size: 0.9rem;"><i class="fas fa-leaf"></i> ${order.totalCarbon.toFixed(1)} kg CO2e</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                ordersContainer.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 30px;">No orders yet</p>';
            }

        } catch (e) {
            console.error('Error loading dashboard:', e);
        }
    }

    // ===== SELLER DASHBOARD =====
    async function loadSellerDashboard() {
        try {
            const res = await fetch(`/api/dashboard/seller/${currentUser.id}`);
            const dashboard = await res.json();

            const stats = dashboard.stats;
            document.getElementById('sellerStats').innerHTML = `
                <div class="stat-card">
                    <div class="icon" style="color: #10b981;"><i class="fas fa-box"></i></div>
                    <div class="value">${stats.totalProducts}</div>
                    <div class="label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #3b82f6;"><i class="fas fa-shopping-cart"></i></div>
                    <div class="value">${stats.totalSales}</div>
                    <div class="label">Total Sales</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #f59e0b;"><i class="fas fa-dollar-sign"></i></div>
                    <div class="value">${stats.totalRevenue.toFixed(2)}</div>
                    <div class="label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #ef4444;"><i class="fas fa-clock"></i></div>
                    <div class="value">${stats.pendingProducts}</div>
                    <div class="label">Pending Verification</div>
                </div>
            `;

            await loadSellerProducts();

        } catch (e) {
            console.error('Error loading seller dashboard:', e);
        }
    }

    async function loadSellerProducts() {
        try {
            const res = await fetch(`/api/products/seller/${currentUser.id}`);
            const products = await res.json();

            const container = document.getElementById('sellerProducts');
            if (products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 30px;">No products yet</p>';
                return;
            }

            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; background: white; border-radius: 12px; overflow: hidden;">
                        <thead style="background: #f9fafb;">
                            <tr>
                                <th style="padding: 15px; text-align: left;">Product</th>
                                <th style="padding: 15px; text-align: left;">Category</th>
                                <th style="padding: 15px; text-align: left;">Price</th>
                                <th style="padding: 15px; text-align: left;">Stock</th>
                                <th style="padding: 15px; text-align: left;">Status</th>
                                <th style="padding: 15px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(p => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 15px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="${p.primaryImage}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                                            <div>
                                                <strong>${p.name}</strong>
                                                <div style="font-size: 0.85rem; color: #6b7280;">${p.soldCount} sold</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 15px;">${p.category}</td>
                                    <td style="padding: 15px;"><strong>${p.price.toFixed(2)}</strong></td>
                                    <td style="padding: 15px;">${p.quantity}</td>
                                    <td style="padding: 15px;">
                                        ${p.verified ? '<span class="badge-A-plus badge">Verified</span>' : '<span class="badge-B badge">Pending</span>'}
                                        ${p.featured ? '<span class="badge-featured badge" style="margin-left: 5px;">Featured</span>' : ''}
                                    </td>
                                    <td style="padding: 15px;">
                                        <button class="btn btn-outline" onclick='editProduct(${JSON.stringify(p)})' style="padding: 6px 12px; margin-right: 5px;">Edit</button>
                                        <button class="btn btn-danger" onclick="deleteProduct(${p.id})" style="padding: 6px 12px;">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (e) {
            console.error('Error loading seller products:', e);
        }
    }

    async function handleProductSubmit(e) {
        e.preventDefault();

        const productId = document.getElementById('editProductId').value;
        const files = document.getElementById('productImages').files;

        let images = '';

        // Upload images if provided
        if (files.length > 0) {
            const formData = new FormData();
            for (let i = 0; i < Math.min(files.length, 5); i++) {
                formData.append('files', files[i]);
            }

            try {
                const uploadRes = await fetch(`/api/products/${productId || 'temp'}/images`, {
                    method: 'POST',
                    body: formData
                });
                if (uploadRes.ok) {
                    const uploadData = await uploadRes.json();
                    images = uploadData.images.join(',');
                }
            } catch (e) {
                showToast('Error uploading images', 'error');
                return;
            }
        }

        const data = {
            userId: currentUser.id,
            name: document.getElementById('prodName').value,
            description: document.getElementById('prodDesc').value,
            price: parseFloat(document.getElementById('prodPrice').value),
            quantity: parseInt(document.getElementById('prodQuantity').value),
            category: document.getElementById('prodCategory').value,
            images: images,
            manufacturing: parseFloat(document.getElementById('prodManu').value),
            transportation: parseFloat(document.getElementById('prodTrans').value),
            packaging: parseFloat(document.getElementById('prodPack').value),
            usage: parseFloat(document.getElementById('prodUsage').value),
            disposal: parseFloat(document.getElementById('prodDisp').value)
        };

        const url = productId ? `/api/products/${productId}` : '/api/products/add';
        const method = productId ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) {
                showToast(productId ? 'Product updated!' : 'Product added!', 'success');
                document.getElementById('productForm').reset();
                document.getElementById('editProductId').value = '';
                document.getElementById('productSubmitBtn').innerHTML = '<i class="fas fa-plus"></i> Add Product';
                document.getElementById('cancelEditBtn').classList.add('hidden');
                loadSellerProducts();
            } else {
                showToast('Error saving product', 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    function editProduct(product) {
        document.getElementById('editProductId').value = product.id;
        document.getElementById('prodName').value = product.name;
        document.getElementById('prodDesc').value = product.description;
        document.getElementById('prodPrice').value = product.price;
        document.getElementById('prodQuantity').value = product.quantity;
        document.getElementById('prodCategory').value = product.category;

        if (product.carbonBreakdown) {
            document.getElementById('prodManu').value = product.carbonBreakdown.manufacturing;
            document.getElementById('prodTrans').value = product.carbonBreakdown.transportation;
            document.getElementById('prodPack').value = product.carbonBreakdown.packaging;
            document.getElementById('prodUsage').value = product.carbonBreakdown.usage;
            document.getElementById('prodDisp').value = product.carbonBreakdown.disposal;
        }

        document.getElementById('productSubmitBtn').innerHTML = '<i class="fas fa-save"></i> Update Product';
        document.getElementById('cancelEditBtn').classList.remove('hidden');
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function cancelEdit() {
        document.getElementById('productForm').reset();
        document.getElementById('editProductId').value = '';
        document.getElementById('productSubmitBtn').innerHTML = '<i class="fas fa-plus"></i> Add Product';
        document.getElementById('cancelEditBtn').classList.add('hidden');
    }

    async function deleteProduct(productId) {
        if (!confirm('Are you sure you want to delete this product?')) return;

        try {
            const res = await fetch(`/api/products/${productId}?userId=${currentUser.id}`, {method: 'DELETE'});
            if (res.ok) {
                showToast('Product deleted', 'success');
                loadSellerProducts();
            } else {
                showToast('Error deleting product', 'error');
            }
        } catch (e) {
            showToast('Error deleting product', 'error');
        }
    }

    // ===== ADMIN DASHBOARD =====
    async function loadAdminDashboard() {
        try {
            const res = await fetch('/api/dashboard/admin');
            const dashboard = await res.json();

            const stats = dashboard.platformStats;
            document.getElementById('adminStats').innerHTML = `
                <div class="stat-card">
                    <div class="icon" style="color: #10b981;"><i class="fas fa-users"></i></div>
                    <div class="value">${stats.totalUsers}</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #3b82f6;"><i class="fas fa-store"></i></div>
                    <div class="value">${stats.totalSellers}</div>
                    <div class="label">Total Sellers</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #f59e0b;"><i class="fas fa-box"></i></div>
                    <div class="value">${stats.totalProducts}</div>
                    <div class="label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #ef4444;"><i class="fas fa-shopping-cart"></i></div>
                    <div class="value">${stats.totalOrders}</div>
                    <div class="label">Total Orders</div>
                </div>
            `;

            // Pending verifications
            const pendingContainer = document.getElementById('pendingProducts');
            if (dashboard.pendingVerifications && dashboard.pendingVerifications.length > 0) {
                pendingContainer.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; background: white; border-radius: 12px; overflow: hidden;">
                            <thead style="background: #f9fafb;">
                                <tr>
                                    <th style="padding: 15px; text-align: left;">Product</th>
                                    <th style="padding: 15px; text-align: left;">Seller</th>
                                    <th style="padding: 15px; text-align: left;">Carbon</th>
                                    <th style="padding: 15px; text-align: left;">Date</th>
                                    <th style="padding: 15px; text-align: left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dashboard.pendingVerifications.map(p => `
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 15px;"><strong>${p.productName}</strong></td>
                                        <td style="padding: 15px;">${p.sellerName}</td>
                                        <td style="padding: 15px;">${p.carbonFootprint.toFixed(1)} kg</td>
                                        <td style="padding: 15px;">${new Date(p.submittedAt).toLocaleDateString()}</td>
                                        <td style="padding: 15px;">
                                            <button class="btn btn-primary" onclick="verifyProduct(${p.productId})" style="padding: 6px 12px;">Verify</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                pendingContainer.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 30px;">No pending verifications</p>';
            }

            await loadAllProducts();

        } catch (e) {
            console.error('Error loading admin dashboard:', e);
        }
    }

    async function loadAllProducts() {
        try {
            const res = await fetch('/api/products?page=0&size=50');
            const data = await res.json();

            const container = document.getElementById('adminProducts');
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; background: white; border-radius: 12px; overflow: hidden;">
                        <thead style="background: #f9fafb;">
                            <tr>
                                <th style="padding: 15px; text-align: left;">ID</th>
                                <th style="padding: 15px; text-align: left;">Product</th>
                                <th style="padding: 15px; text-align: left;">Seller</th>
                                <th style="padding: 15px; text-align: left;">Price</th>
                                <th style="padding: 15px; text-align: left;">Status</th>
                                <th style="padding: 15px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.products.map(p => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 15px;">#${p.id}</td>
                                    <td style="padding: 15px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="${p.primaryImage}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                                            <strong>${p.name}</strong>
                                        </div>
                                    </td>
                                    <td style="padding: 15px;">${p.sellerName}</td>
                                    <td style="padding: 15px;"><strong>${p.price.toFixed(2)}</strong></td>
                                    <td style="padding: 15px;">
                                        ${p.verified ? '<span class="badge-A-plus badge">Verified</span>' : '<span class="badge-B badge">Pending</span>'}
                                        ${p.featured ? '<span class="badge-featured badge" style="margin-left: 5px;">Featured</span>' : ''}
                                    </td>
                                    <td style="padding: 15px;">
                                        <button class="btn btn-secondary" onclick="toggleFeatured(${p.id})" style="padding: 6px 12px; margin-right: 5px;">
                                            ${p.featured ? 'Unfeature' : 'Feature'}
                                        </button>
                                        <button class="btn btn-danger" onclick="deleteProduct(${p.id})" style="padding: 6px 12px;">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (e) {
            console.error('Error loading all products:', e);
        }
    }

    async function verifyProduct(productId) {
        try {
            const res = await fetch(`/api/products/admin/verify/${productId}?adminId=${currentUser.id}`, {method: 'PUT'});
            if (res.ok) {
                showToast('Product verified!', 'success');
                loadAdminDashboard();
            }
        } catch (e) {
            showToast('Error verifying product', 'error');
        }
    }

    async function toggleFeatured(productId) {
        try {
            const res = await fetch(`/api/products/${productId}/feature?adminId=${currentUser.id}`, {method: 'PUT'});
            if (res.ok) {
                showToast('Featured status updated!', 'success');
                loadAllProducts();
            }
        } catch (e) {
            showToast('Error updating featured status', 'error');
        }
    }

    // ===== UTILITIES =====
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}" style="font-size: 1.5rem; color: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>
</body>
</html>